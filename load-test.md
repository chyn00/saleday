
## 성능 테스트 결과(Tomcat Thread Pool, HikariCP, Warm-up 튜닝 활용)

**본 테스트는 싱글 인스턴스 환경에서 수행되었습니다.**

서비스는 분산 환경에서도 안정적으로 동작하도록 설계되었으며, 수평 확장(Scale-Out)이 가능합니다.

---

### 같은 PC의 물리 자원에서, 멀티 인스턴스 테스트 제외 이유

**같은 물리 자원(CPU, 메모리, 네트워크 등)을 공유하는 단일 머신에서 여러 인스턴스를 실행할 경우**,  
커넥션 풀 자원 고갈, 스레드 간의 경쟁 등 **동일 머신 내에서 자원 경합**이 발생하여, 멀티 인스턴스 환경의 성능 측정 결과를 정확히 측정하기 어렵습니다.

> **이러한 상황은 실제 클라우드 기반의 분산 환경의 성능 측정을 하기에는 적합하지 않습니다.**  
> 따라서 본 테스트는 **싱글 인스턴스 기준으로 측정**되었습니다.

단, 멀티 인스턴스 환경에서도 **Redis 원자 연산**, **Kafka 메시지 처리**, **DB 반영 정합성** 등은 정상적으로 작동함을 테스트를 통해 확인하였습니다.

---

### 테스트 개요

- 도구: [Locust](https://locust.io/) (헤드리스 모드)
- 요청 수: 100,000건
- 요청 속도: 1,000 TPS
- 대상 API: `POST /order/stock/limit`
- 초기 재고: 1,000,000개
- 요청당 감소 수량: 1개

---

### 적용된 성능 최적화

- **Tomcat Thread Pool (`maxThreads`) 조정** – I/O bound 환경에 맞춰 튜닝
- **HikariCP 커넥션 풀 설정 최적화**
- **JVM Warm-up 적용** – 사전 컴파일로 cold start 방지
- **Redis 원자 연산 처리 + Kafka 기반 비동기 구조**
- **Outbox Pattern** – 메시지 정합성 보완 및 추적성 확보

---

### 정합성 보장 요소

| 처리 단계           | 설명 |
|--------------------|------|
| Redis 선처리        | `INCR`, `DECR`을 통한 원자 재고 감소 |
| Kafka 비동기 처리   | 주문 정보를 Kafka 토픽으로 전달 |
| DB 후속 저장        | Consumer를 통해 비동기 재고 감소 저장 |
| Outbox 활용         | 이벤트 중복 처리 방지 및 정합성 보완 |
| 멀티 인스턴스 확인 | 다중 인스턴스 환경에서도 정합성 이상 없음 확인됨 |

---

## Tomcat Thread Pool, HikariCP, Warm-up 튜닝 성능 비교(+ ACK로 정합성 개선)

| Percentile    | Default<br>(Tomcat 200 / Hikari 기본) | x30 Threads<br>(Tomcat 300 / Hikari 기본) | x30 Threads + Hikari 300 | + Warm-up (RestClient 50회) | + ACK를 활용한 정합성 향상<br> Warm-up 200회|
|---------------|----------------------------------------|--------------------------------------------|----------------------------|-----------------------------|-------------------------------|
| **100%**      | 1900ms                                 | 1900ms ✅                                   | 1630ms ✅                  | **960ms ✅**                | **1200ms ✅**                 |
| **99.99%**    | 1500ms                                 | 1800ms ❌                                   | 1600ms ❌                  | **950ms ✅**                | **1200ms ✅**                 |
| **99.9%**     | 1300ms                                 | 1400ms ❌                                   | 1200ms ✅                  | **960ms ✅**                | **930ms ✅**                  |
| **99%**       | 670ms                                  | 880ms ❌                                   | 500ms ✅                   | **320ms ✅**                | **420ms ✅**                  |
| **98%**       | 550ms                                  | 650ms ❌                                   | 310ms ✅                   | **270ms ✅**                | **360ms ✅**                  |
| **95%**       | 490ms                                  | 450ms ✅                                   | 280ms ✅                   | **240ms ✅**                | **320ms ✅**                  |
| **90%**       | 400ms                                  | 350ms ✅                                   | 230ms ✅                   | **210ms ✅**                | **300ms ✅**                  |
| **80%**       | 360ms                                  | 290ms ✅                                   | 210ms ✅                   | **190ms ✅**                | **250ms ✅**                  |
| **75%**       | 340ms                                  | 270ms ✅                                   | 210ms ✅                   | **180ms ✅**                | **230ms ✅**                  |
| **66%**       | 300ms                                  | 240ms ✅                                   | 190ms ✅                   | **160ms ✅**                | **190ms ✅**                  |
| **50% (P50)** | 230ms                                  | 160ms ✅                                   | 140ms ✅                   | **170ms ✅**                | **150ms ✅**                  |
| **평균**        | 208ms                                  | 190ms ✅                                   | 154ms ✅                   | **185ms ✅**                | **169ms ✅**                  |
| **요청 수**      | 99,999                                 | 99,989                                     | 100,000                    | 100,000                     | 100,000                       |
| **실패 수**      | 0                                      | 0                                          | 0                          | 0                           | 0                             |



---

## Tomcat Thread Pool 별 테스트 결과 요약(CPU 논리코어 10가정)

| Percentile    | Default<br>(기본값 200) | x50 Threads | x30 Threads | x18 Threads | x15 Threads | x10 Threads |
| ------------- | -------------------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| **100%**      | 1900                 | 2800 ❌      | **1900 ✅**  | **1600 ✅**  | **1600 ✅**  | **1600 ✅**  |
| **99.99%**    | 1500                 | 2100 ❌      | **1800 ✅**  | **1600 ✅**  | **1600 ✅**  | **1300 ✅**  |
| **99.9%**     | 1300                 | 1700 ❌      | **1400 ✅**  | **1200 ✅**  | **1200 ✅**  | **1200 ✅**  |
| **99%**       | 670                  | 750 ❌       | **880 ❌**   | **400 ✅**   | **400 ✅**   | **400 ✅**   |
| **98%**       | 550                  | 500 ✅       | **650 ❌**   | **500 ↔**   | **480 ✅**   | **440 ✅**   |
| **95%**       | 490                  | 360 ✅       | **450 ✅**   | **480 ✅**   | **480 ✅**   | **440 ✅**   |
| **90%**       | 400                  | 330 ✅       | **350 ✅**   | **400 ↔**   | **400 ↔**   | **400 ↔**   |
| **80%**       | 360                  | 310 ✅       | **290 ✅**   | **360 ↔**   | **360 ↔**   | **370 ❌**   |
| **75%**       | 340                  | 300 ✅       | **270 ✅**   | **340 ↔**   | **340 ↔**   | **350 ❌**   |
| **66%**       | 300                  | 260 ✅       | **240 ✅**   | **300 ↔**   | **300 ↔**   | **330 ❌**   |
| **50% (Med)** | 230                  | 210 ✅       | **160 ✅**   | **240 ❌**   | **240 ❌**   | **270 ❌**   |
| **평균**        | 208                  | 208 ↔       | **190 ✅**   | **253 ❌**   | **253 ❌**   | **264 ❌**   |
| **# 요청수**     | 99,999               | 99,946      | 99,989      | 100,000     | 100,000     | 100,000     |
| **# 실패수**     | 0                    | 0           | 0           | 0           | 0           | 0           |

---

## Tomcat Thread Pool 분석 요약

- **x30 설정**에서 대부분의 응답 시간 구간에서 **개선된 수치**를 보였으며, 평균 응답 시간 또한 가장 낮았습니다.
- **x15, x18 설정**도 응답 시간의 안정성 측면에서는 준수한 성능을 보였지만, 평균 응답 시간이 다소 높아졌습니다.
- **x50**은 과도한 context switching으로 인해 최대 응답 시간이 오히려 증가함을 확인했습니다.


## 정합성 테스트 결과
> 최초 1,000,000의 재고에서 99,999개의 재고감소 요청<br>
> Redis, Outbox, Consumer Module DB의 재고량 및 처리량 모두 같음

**Redis 결과**<br>

- <img width="543" height="54" alt="image" src="https://github.com/user-attachments/assets/86704bcb-befd-40a6-8b35-1696cf29b914" /><br>

**Kafka(컨슈머 + RLock) DB 결과** <br>

- <img width="1159" height="44" alt="image" src="https://github.com/user-attachments/assets/5bf991e2-f259-484c-9e47-78119b59862f" /><br>

**Outbox 테이블 Count 결과**<br>

- <img width="230" height="79" alt="image" src="https://github.com/user-attachments/assets/b7a22cec-9d0f-4a61-824a-f994299e9938" /><br>

## 비고
- 싱글 인스턴스를 최적화하여 확장 할 수 있도록 설계
