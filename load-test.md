
## Tomcat Thread Pool 설정별 성능 비교
> 본 테스트는 **싱글 인스턴스 환경**에서 실행되었습니다.  
> 서비스 구조는 분산 환경에 맞게 개발되어 있어, 언제든 **Scale Out(확장)** 이 가능합니다.

- Locust를 활용한 10만건의 1,000TPS 테스트 시, Redis로 선처리 후 RDB 후속처리 정합성 테스트 통과
- 카프카 비동기 후속 DB 처리 정합성(Redisson Lock과 함께 활용), Outbox Pattern(추후 정합성 보정을 위해 필요), Redis 원자성 재고 감소 정합성
- 최초 1,000,000의 재고에서 약 100,000개의 재고감소 요청 테스트
- 배치 병합으로 인한 속도 개선

- Spring Boot 내장 Tomcat 서버의 워커 스레드 설정(`maxThreads`)을 조정하여, I/O Bound 성격의 API(`/order/stock/limit`)에 대한 **응답 시간과 처리량(TPS)**을 측정하였습니다.
- 테스트는 [Locust](https://locust.io/)를 사용하여 100,000건의 요청을 기준으로 진행되었습니다.
- Warm-up을 활용하여, 최종속도를 개선했습니다.

## Tomcat Thread Pool, HikariCP, Warm-up 튜닝 성능 비교

| Percentile    | Default<br>(Tomcat 200 / Hikari 기본) | x30 Threads<br>(Tomcat 300 / Hikari 기본) | x30 Threads + Hikari 300 | + Warm-up (RestClient 50회) |
|---------------|----------------------------------------|--------------------------------------------|----------------------------|-----------------------------|
| **100%**      | 1900ms                                 | 1900ms ✅                                   | 1630ms ✅                  | **960ms ✅**                |
| **99.99%**    | 1500ms                                 | 1800ms ✅                                   | 1600ms ✅                  | **950ms ✅**                |
| **99.9%**     | 1300ms                                 | 1400ms ✅                                   | 1200ms ✅                  | **960ms ✅**                |
| **99%**       | 670ms                                  | 880ms ❌                                   | 500ms ✅                   | **320ms ✅**                |
| **98%**       | 550ms                                  | 650ms ❌                                   | 310ms ✅                   | **270ms ✅**                |
| **95%**       | 490ms                                  | 450ms ✅                                   | 280ms ✅                   | **240ms ✅**                |
| **90%**       | 400ms                                  | 350ms ✅                                   | 230ms ✅                   | **210ms ✅**                |
| **80%**       | 360ms                                  | 290ms ✅                                   | 210ms ✅                   | **190ms ✅**                |
| **75%**       | 340ms                                  | 270ms ✅                                   | 210ms ✅                   | **180ms ✅**                |
| **66%**       | 300ms                                  | 240ms ✅                                   | 190ms ✅                   | **160ms ✅**                |
| **50% (P50)** | 230ms                                  | 160ms ✅                                   | 140ms ✅                   | **170ms ✅**                |
| **평균**        | 208ms                                  | 190ms ✅                                   | 154ms ✅                   | **185ms ✅**                |
| **요청 수**      | 99,999                                 | 99,989                                     | 100,000                    | 100,000                     |
| **실패 수**      | 0                                      | 0                                          | 0                          | 0                           |


---

## Tomcat Thread Pool 별 테스트 결과 요약(CPU 논리코어 10가정)

| Percentile    | Default<br>(기본값 200) | x50 Threads | x30 Threads | x18 Threads | x15 Threads | x10 Threads |
| ------------- | -------------------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| **100%**      | 1900                 | 2800 ❌      | **1900 ✅**  | **1600 ✅**  | **1600 ✅**  | **1600 ✅**  |
| **99.99%**    | 1500                 | 2100 ❌      | **1800 ✅**  | **1600 ✅**  | **1600 ✅**  | **1300 ✅**  |
| **99.9%**     | 1300                 | 1700 ❌      | **1400 ✅**  | **1200 ✅**  | **1200 ✅**  | **1200 ✅**  |
| **99%**       | 670                  | 750 ❌       | **880 ❌**   | **400 ✅**   | **400 ✅**   | **400 ✅**   |
| **98%**       | 550                  | 500 ✅       | **650 ❌**   | **500 ↔**   | **480 ✅**   | **440 ✅**   |
| **95%**       | 490                  | 360 ✅       | **450 ✅**   | **480 ✅**   | **480 ✅**   | **440 ✅**   |
| **90%**       | 400                  | 330 ✅       | **350 ✅**   | **400 ↔**   | **400 ↔**   | **400 ↔**   |
| **80%**       | 360                  | 310 ✅       | **290 ✅**   | **360 ↔**   | **360 ↔**   | **370 ❌**   |
| **75%**       | 340                  | 300 ✅       | **270 ✅**   | **340 ↔**   | **340 ↔**   | **350 ❌**   |
| **66%**       | 300                  | 260 ✅       | **240 ✅**   | **300 ↔**   | **300 ↔**   | **330 ❌**   |
| **50% (Med)** | 230                  | 210 ✅       | **160 ✅**   | **240 ❌**   | **240 ❌**   | **270 ❌**   |
| **평균**        | 208                  | 208 ↔       | **190 ✅**   | **253 ❌**   | **253 ❌**   | **264 ❌**   |
| **# 요청수**     | 99,999               | 99,946      | 99,989      | 100,000     | 100,000     | 100,000     |
| **# 실패수**     | 0                    | 0           | 0           | 0           | 0           | 0           |

---

## Tomcat Thread Pool 분석 요약

- **x30 설정**에서 대부분의 응답 시간 구간에서 **개선된 수치**를 보였으며, 평균 응답 시간 또한 가장 낮았습니다.
- **x15, x18 설정**도 응답 시간의 안정성 측면에서는 준수한 성능을 보였지만, 평균 응답 시간이 다소 높아졌습니다.
- **x50**은 과도한 context switching으로 인해 최대 응답 시간이 오히려 증가함을 확인했습니다.


## 정합성 테스트 결과
> 최초 1,000,000의 재고에서 99,999개의 재고감소 요청<br>
> Redis, Outbox, Consumer Module DB의 재고량 모두 같음

**Redis 결과**<br>

- <img width="543" height="54" alt="image" src="https://github.com/user-attachments/assets/86704bcb-befd-40a6-8b35-1696cf29b914" /><br>

**Kafka(컨슈머 + RLock) DB 결과** <br>

- <img width="1159" height="44" alt="image" src="https://github.com/user-attachments/assets/5bf991e2-f259-484c-9e47-78119b59862f" /><br>

**Outbox 테이블 Count 결과**<br>

- <img width="230" height="79" alt="image" src="https://github.com/user-attachments/assets/b7a22cec-9d0f-4a61-824a-f994299e9938" /><br>

## 특이사항
- 더 높은 트래픽에서, RDB와의 Sync 속도가 느려짐(정합성은 틀어지지 않음)
- 영속성 저장에 대한 정합성을 높이고, 속도가 느리더라도 정확히 보장하기 위한 Trade-off

## 테스트 예외
- 멀티 인스턴스 환경 테스트 예외
- 싱글 인스턴스를 최적화하여 확장 할 수 있도록 설계
